<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fishy Chat</title>
<link rel="icon" href="image.png">
<style>
body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; }
#messages { border: 1px solid #ccc; padding: 10px; max-height: 400px; overflow-y: auto; margin-bottom: 10px; }
.message { border-bottom: 1px solid #eee; padding: 5px; }
.message img { max-width: 150px; display: block; margin-top: 5px; }
input { margin: 5px; padding: 5px; }
button { padding: 5px 10px; }
</style>
</head>
<body>

<h1 id="chatTitle" style="font-size: 80px; font-family: cursive;">
<img src="image.png" alt="Fish Chat" style="width: 220px; height: 170px;"> Fishy Chat :)
</h1>

<div id="messages"></div>

<input type="text" id="title" placeholder="Name" style="width: 200px;">
<input type="text" id="text" placeholder="Message" style="width: 300px;">
<input type="text" id="image" placeholder="Image URL" style="width: 200px;">
<br>
<button id="sendBtn">Send</button>
<button id="newChatBtn">Start New Room</button>
<br>
<a id="chatLink" href="#" target="_blank"></a>

<!-- Firebase Compat Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // ---------------- Firebase Config ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyCx9HdgT3orb_ToBoN_Xnnc22QKfp3yTP0",
    authDomain: "fishy-chat-60a51.firebaseapp.com",
    databaseURL: "https://fishy-chat-60a51-default-rtdb.firebaseio.com",
    projectId: "fishy-chat-60a51",
    storageBucket: "fishy-chat-60a51.firebasestorage.app",
    messagingSenderId: "707437730841",
    appId: "1:707437730841:web:160bc64f2782a32af79e88",
    measurementId: "G-8FR6X8G9P9"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ---------------- Chat Setup ----------------
  function generateID(length = 12) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let id = '';
      for (let i = 0; i < length; i++) {
          id += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return id;
  }

  let chatID = location.hash.slice(1);
  if (!chatID) {
      chatID = generateID();
      location.hash = chatID;
  }

  const link = document.getElementById('chatLink');
  link.href = `#${chatID}`;
  link.textContent = `${link.href}`;

  const messagesDiv = document.getElementById('messages');
  const titleInput = document.getElementById('title');
  const textInput = document.getElementById('text');
  const imageInput = document.getElementById('image');

  let messagesRef = db.ref('chats/' + chatID);

  // ---------------- Sounds ----------------
  const sendSound = new Audio(); // sound when sending
  sendSound.src = "send.mp3"; // sound on send
  const receiveSound = new Audio(); // sound on new message
  receiveSound.src = "receive.mp3"; // sound on new message

  let lastMessageCount = 0;

  // ---------------- Load messages live ----------------
  function loadMessages() {
      messagesRef.on('value', snapshot => {
          const data = snapshot.val() || {};
          const messagesArray = Object.values(data);

          // Play sound if new message added
          if (messagesArray.length > lastMessageCount) {
              // Avoid playing sound for messages sent by this user immediately
              const lastMessage = messagesArray[messagesArray.length - 1];
              if (!(lastMessage.title === titleInput.value.trim() && lastMessage.text === textInput.value.trim())) {
                  receiveSound.play();
              }
          }
          lastMessageCount = messagesArray.length;

          messagesDiv.innerHTML = '';
          messagesArray.forEach(msg => {
              const div = document.createElement('div');
              div.className = 'message';
              div.innerHTML = `<strong>${msg.title}</strong><br>${msg.text}`;
              if (msg.image) {
                  const img = document.createElement('img');
                  img.src = msg.image;
                  div.appendChild(img);
              }
              messagesDiv.appendChild(div);
          });
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });
  }

  loadMessages();

  // ---------------- Send Message ----------------
  document.getElementById('sendBtn').addEventListener('click', () => {
      const title = titleInput.value.trim();
      const text = textInput.value.trim();
      const image = imageInput.value.trim();
      if (!text && !image) return;

      messagesRef.push({ title, text, image });

      titleInput.value = '';
      textInput.value = '';
      imageInput.value = '';

      sendSound.play(); // play sound when sending
  });

  // ---------------- New Chat ----------------
  document.getElementById('newChatBtn').addEventListener('click', () => {
      chatID = generateID();
      location.hash = chatID;
      messagesRef = db.ref('chats/' + chatID);
      link.href = `#${chatID}`;
      link.textContent = `${link.href}`;
      loadMessages();
      lastMessageCount = 0; // reset counter for new chat
  });

</script>
</body>
</html>
